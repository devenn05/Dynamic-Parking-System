<div class="container">
  <h2 class="mat-headline-medium">Parking Sessions</h2>

  <!-- Filters Card -->
  <mat-card class="card" style="margin-bottom: 20px; padding: 15px;">
    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
      
      <!-- 1. Lot Selection -->
      <mat-form-field appearance="outline" style="width: 40vh;">
        <mat-label>Select Parking Lot</mat-label>
        <mat-select [ngModel]="selectedLotId()" (ngModelChange)="selectedLotId.set($event); loadData()">
          <mat-option [value]="null">All Lots</mat-option>
          <mat-option *ngFor="let lot of lots()" [value]="lot.id">{{ lot.name }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- 2. Vehicle Search -->
      <mat-form-field appearance="outline" style="flex: 1;">
        <mat-label>Search Vehicle No.</mat-label>
        <input matInput [ngModel]="searchTerm()" (ngModelChange)="searchTerm.set($event)" placeholder="e.g. MH12">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <!-- 3. Reset -->
      <button mat-stroked-button color="warn" (click)="resetFilters()">
        <mat-icon>refresh</mat-icon> Reset
      </button>
    </div>
  </mat-card>

  <!-- MATERIAL TABS -->
  <mat-tab-group animationDuration="0ms">
    
    <!-- ACTIVE TAB -->
    <mat-tab label="Active Vehicles">
      <div class="mat-elevation-z2">
        <table mat-table [dataSource]="activeDataSource" matSort #activeSort="matSort">
          
          <ng-container matColumnDef="vehicleNumber">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Vehicle </th>
            <td mat-cell *matCellDef="let s"> {{s.vehicleNumber}} </td>
          </ng-container>

          <ng-container matColumnDef="vehicleType">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Type </th>
            <td mat-cell *matCellDef="let s"> {{s.vehicleType}} </td>
          </ng-container>

          <ng-container matColumnDef="parkingLotName">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Parking Lot </th>
            <td mat-cell *matCellDef="let s"> {{s.parkingLotName}} </td>
          </ng-container>

          <ng-container matColumnDef="slotNumber">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Slot </th>
            <td mat-cell *matCellDef="let s"> {{s.slotNumber}} </td>
          </ng-container>

          <ng-container matColumnDef="entryTime">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Entry Time (mm/dd/yyyy)</th>
            <td mat-cell *matCellDef="let s"> {{s.entryTime | date:'short'}} </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef style="text-align: center;"> Actions </th>
            <td mat-cell *matCellDef="let s" style="text-align: center;">
              <button mat-mini-fab color="warn" (click)="onTerminate(s)" title="Terminate Session">
                <mat-icon>power_settings_new</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="activeColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: activeColumns;"></tr>
        </table>
        
        <mat-paginator #activePaginator [pageSize]="5" [pageSizeOptions]="[5, 10, 20]"></mat-paginator>
      </div>
    </mat-tab>

    <!-- HISTORY TAB -->
    <mat-tab label="All Records (History)">
      <div class="mat-elevation-z2">
        <table mat-table [dataSource]="historyDataSource" matSort #historySort="matSort" >
          
          <ng-container matColumnDef="vehicleNumber">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Vehicle </th>
            <td mat-cell *matCellDef="let s"> {{s.vehicleNumber}} </td>
          </ng-container>

          <ng-container matColumnDef="vehicleType">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Type </th>
            <td mat-cell *matCellDef="let s"> {{s.vehicleType}} </td>
          </ng-container>

          <ng-container matColumnDef="parkingLotName">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Lot </th>
            <td mat-cell *matCellDef="let s"> {{s.parkingLotName}} </td>
          </ng-container>

          <ng-container matColumnDef="slotNumber">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Slot </th>
            <td mat-cell *matCellDef="let s"> {{s.slotNumber}} </td>
          </ng-container>

          <ng-container matColumnDef="entryTime">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Entry (mm/dd/yyyy)</th>
            <td mat-cell *matCellDef="let s"> {{s.entryTime | date:'short'}} </td>
          </ng-container>

          <ng-container matColumnDef="exitTime">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Exit (mm/dd/yyyy) </th>
            <td mat-cell *matCellDef="let s"> {{s.exitTime ? (s.exitTime | date:'short') : '-'}} </td>
          </ng-container>

          <ng-container matColumnDef="totalAmount">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Bill </th>
            <td mat-cell *matCellDef="let s"> 
               <span *ngIf="s.totalAmount > 0">â‚¹{{s.totalAmount}}</span>
               <span *ngIf="s.totalAmount === 0 && s.status !== 'TERMINATED'" style="color: green; font-weight: bold;">FREE</span>
               <span *ngIf="s.status === 'TERMINATED'">-</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Status </th>
            <td mat-cell *matCellDef="let s"> 
              <span [style.color]="s.status === 'ACTIVE' ? 'orange' : (s.status === 'COMPLETED' ? 'green' : 'red')">
                {{s.status}}
              </span>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="historyColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: historyColumns;"></tr>
        </table>

        <mat-paginator #historyPaginator [pageSize]="10" [pageSizeOptions]="[10, 25, 50]"></mat-paginator>
      </div>
    </mat-tab>

  </mat-tab-group>
</div>